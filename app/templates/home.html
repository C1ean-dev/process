{% extends "base.html" %}
{% block content %}
<div class="container py-5">
    <!-- Hero Section -->
    <div class="jumbotron text-center bg-white shadow-sm border rounded">
        <h1 class="display-4 text-primary font-weight-bold">
            <i class="fas fa-file-contract mr-2"></i>File Processor
        </h1>
        <p class="lead text-muted">Intelligent document analysis and processing at your fingertips.</p>
        <hr class="my-4">
        
        {% if current_user.is_authenticated %}
            <p class="mb-4">Welcome back, <strong>{{ current_user.username }}</strong>! Ready to process more documents?</p>
            <div class="d-flex justify-content-center">
                <a class="btn btn-primary btn-lg mr-3 shadow-sm" href="{{ url_for('files.upload_file') }}" role="button">
                    <i class="fas fa-upload mr-2"></i>Upload New File
                </a>
                <a class="btn btn-outline-secondary btn-lg shadow-sm" href="{{ url_for('files.view_data') }}" role="button">
                    <i class="fas fa-table mr-2"></i>View Data
                </a>
            </div>
        {% else %}
            <p class="mb-4">Securely upload, automatically extract data, and manage your document workflows efficiently.</p>
            <a class="btn btn-success btn-lg shadow-sm px-5" href="{{ url_for('auth.login') }}" role="button">
                <i class="fas fa-sign-in-alt mr-2"></i>Login to Start
            </a>
        {% endif %}
    </div>

    <!-- System Status Section -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="d-flex align-items-center mb-3">
                <h3 class="mb-0 mr-3">Status do Sistema</h3>
                <div id="overall-status-badge">
                    <span class="badge badge-secondary px-3 py-2">Verificando...</span>
                </div>
            </div>
            <div class="row" id="services-status-grid">
                <!-- Services will be injected here -->
                <div class="col-md-2 col-sm-4 mb-3">
                    <div class="card bg-light border-0 shadow-sm text-center py-3">
                        <div class="spinner-border spinner-border-sm text-muted mx-auto" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <div class="row mt-5">
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
                <div class="card-body text-center">
                    <div class="mb-3 text-primary">
                        <i class="fas fa-cloud-upload-alt fa-3x"></i>
                    </div>
                    <h4 class="card-title">Easy Upload</h4>
                    <p class="card-text text-muted">Drag & drop your PDF documents for instant processing. We handle the heavy lifting for you.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
                <div class="card-body text-center">
                    <div class="mb-3 text-success">
                        <i class="fas fa-cogs fa-3x"></i>
                    </div>
                    <h4 class="card-title">Smart Extraction</h4>
                    <p class="card-text text-muted">Our workers automatically identify and extract key information like names, dates, and equipment IDs.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
                <div class="card-body text-center">
                    <div class="mb-3 text-info">
                        <i class="fas fa-chart-line fa-3x"></i>
                    </div>
                    <h4 class="card-title">Real-time Tracking</h4>
                    <p class="card-text text-muted">Monitor the status of your documents in real-time and access extracted data through a clean dashboard.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Health Details Modal -->
<div class="modal fade" id="healthModal" tabindex="-1" role="dialog" aria-labelledby="healthModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="healthModalLabel">
                    <i class="fas fa-info-circle mr-2"></i>Detalhes do Serviço: <span id="modal-service-name"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="service-status-info" class="mb-4">
                    <!-- Status specific info -->
                </div>
                <div class="card bg-light border-0">
                    <div class="card-body">
                        <h6 class="font-weight-bold"><i class="fas fa-tools mr-2"></i>Impacto no Sistema:</h6>
                        <p id="modal-service-impact" class="mb-0"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('{{ url_for("files.health") }}')
            .then(response => response.json())
            .then(data => {
                const badgeContainer = document.getElementById('overall-status-badge');
                const servicesGrid = document.getElementById('services-status-grid');
                
                // Update Overall Badge
                if (data.status === 'healthy') {
                    badgeContainer.innerHTML = '<span class="badge badge-success px-3 py-2"><i class="fas fa-check-circle mr-1"></i>Todos os Sistemas Operacionais</span>';
                } else {
                    badgeContainer.innerHTML = '<span class="badge badge-warning px-3 py-2 text-white"><i class="fas fa-exclamation-triangle mr-1"></i>Problemas Identificados</span>';
                }

                // Update Services Grid
                let gridHtml = '';
                const serviceIcons = {
                    'database': 'fa-database',
                    'mq': 'fa-exchange-alt',
                    'storage': 'fa-cloud',
                    'tesseract': 'fa-font',
                    'poppler': 'fa-file-pdf'
                };

                for (const [key, service] of Object.entries(data.services)) {
                    let statusClass = service.status ? 'text-success' : 'text-danger';
                    let badgeClass = service.status ? 'badge-success-soft' : 'badge-danger-soft';
                    let label = service.status ? 'Operacional' : 'Falha';
                    let borderColor = service.status ? '#28a745' : '#dc3545';

                    if (service.is_warning) {
                        statusClass = 'text-warning';
                        badgeClass = 'badge-warning-soft';
                        label = 'Atenção';
                        borderColor = '#ffc107';
                    }
                    
                    const icon = serviceIcons[key] || 'fa-server';
                    
                    gridHtml += `
                        <div class="col-md-2 col-sm-4 mb-3">
                            <div class="card h-100 border-0 shadow-sm text-center py-3 hover-shadow transition-all" 
                                 style="cursor: pointer; border-bottom: 3px solid ${borderColor} !important;"
                                 onclick="showServiceDetails('${key}', ${JSON.stringify(service).replace(/"/g, '&quot;')})">
                                <div class="mb-2 ${statusClass}">
                                    <i class="fas ${icon} fa-2x"></i>
                                </div>
                                <h6 class="mb-1 small font-weight-bold text-dark">${service.name}</h6>
                                <span class="badge ${badgeClass} small">
                                    ${label}
                                </span>
                            </div>
                        </div>
                    `;
                }
                servicesGrid.innerHTML = gridHtml;
            })
            .catch(error => {
                console.error('Error fetching health status:', error);
                document.getElementById('overall-status-badge').innerHTML = '<span class="badge badge-danger px-3 py-2">Erro na Verificação</span>';
            });
    });

    function showServiceDetails(key, service) {
        document.getElementById('modal-service-name').innerText = service.name;
        document.getElementById('modal-service-impact').innerText = service.impact;
        
        const infoDiv = document.getElementById('service-status-info');
        if (service.is_warning) {
            infoDiv.innerHTML = `
                <div class="alert alert-warning">
                    <h6 class="alert-heading font-weight-bold"><i class="fas fa-exclamation-triangle mr-2"></i>Modo de Contingência Ativo</h6>
                    <p class="mb-0 small">${service.message}</p>
                </div>
            `;
        } else if (service.status) {
            infoDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle mr-2"></i>O serviço está funcionando corretamente.
                </div>
            `;
        } else {
            infoDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6 class="alert-heading font-weight-bold"><i class="fas fa-times-circle mr-2"></i>Falha Detectada</h6>
                    <p class="mb-0 small">${service.message}</p>
                </div>
            `;
        }
        
        $('#healthModal').modal('show');
    }
</script>

<style>
    /* Status Section Styles */
    .badge-success-soft {
        background-color: #d4edda;
        color: #155724;
    }
    .badge-danger-soft {
        background-color: #f8d7da;
        color: #721c24;
    }
    .badge-warning-soft {
        background-color: #fff3cd;
        color: #856404;
    }

    /* Existing styles */
    .hover-shadow:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
    .transition-all {
        transition: all 0.3s ease;
    }
</style>
{% endblock content %}